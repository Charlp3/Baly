<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Suivi de mon chien ‚Äì v1.9c</title>

<style>
  body { font-family: Arial, sans-serif; margin:0; background:#D0E4F7; color:#1C2A40; }
  header { background:#2C5E99; color:#fff; text-align:center; padding:15px; }

  nav { display:flex; background:#1C3B68; flex-wrap:wrap; }
  nav button{
    flex:1 1 25%;
    padding:12px;
    background:#1C3B68;
    color:#fff;
    border:none;
    font-size:1rem;
  }
  nav button.active{
    background:#D0E4F7;
    color:#1C3B68;
    font-weight:bold;
  }

  section { display:none; padding:20px; }
  section.active { display:block; }

  label { display:block; margin-top:10px; font-weight:bold; }
  input, textarea{
    width:100%;
    padding:8px;
    margin-top:4px;
    border-radius:4px;
    border:1px solid #587EA3;
    background:#F0F8FF;
    font-size:1rem;
    box-sizing:border-box;
  }

  /* üî† FICHE : polices agrandies */
  #fiche label { font-size:1.1rem; }
  #fiche input, #fiche textarea { font-size:1.15rem; padding:10px; }

  button.action{
    margin-top:12px;
    padding:10px 15px;
    background:#2C5E99;
    color:#fff;
    border:none;
    border-radius:5px;
    font-size:1rem;
  }

  button.suppr{
    background:#C0392B;
    color:#fff;
    border:none;
    border-radius:4px;
    padding:4px 8px;
    font-size:0.8rem;
    margin-top:6px;
  }
  button.suppr:active { background:#922B21; }

  hr { margin:18px 0; }
  a { color:#1C3B68; word-break:break-all; }

  .ligne { margin-bottom:10px; }
  .note { font-size:0.95rem; opacity:0.9; margin-top:6px; }
  .petit { font-size:0.92rem; opacity:0.9; }
</style>
</head>

<body>

<header>
  Suivi de mon chien üêæ<br>
  <small>¬© Pierre Charlier 2025 ‚Äî Version 1.9c</small>
</header>

<nav>
  <button class="active" onclick="showTab('fiche', this)">Fiche</button>
  <button onclick="showTab('sante', this)">Sant√©</button>
  <button onclick="showTab('pdf', this)">Passeport PDF</button>
  <button onclick="showTab('liens', this)">Liens Web</button>
</nav>

<main>

<!-- ================= FICHE ================= -->
<section id="fiche" class="active">
  <label>Puce</label><input id="puce">
  <label>Passeport</label><input id="passeport">

  <label>Date de naissance</label>
  <input type="date" id="naissance" onchange="updateAge(); saveData(false)">
  <div><strong>√Çge :</strong> <span id="age">-</span></div>

  <label>Poids (kg)</label><input type="number" id="poids">
  <label>V√©t√©rinaire</label><input id="veto">
  <label>T√©l√©phone</label><input id="tel">
  <label>Clinique</label><input id="clinique">

  <label>Nourriture</label><textarea id="nourriture"></textarea>
  <label>Accessoires</label><textarea id="accessoires"></textarea>
  <label>Autres</label><textarea id="autres"></textarea>

  <button class="action" onclick="saveData(true)">üíæ Sauvegarder</button>
  <button class="action" onclick="exportData()">üì§ Exporter JSON</button>

  <input type="file" id="importInput" accept="application/json" hidden onchange="importData(event)">
  <button class="action" onclick="document.getElementById('importInput').click()">üì• Importer</button>
</section>

<!-- ================= SANTE ================= -->
<section id="sante">
  <h3>Maladies</h3>
  <div id="listeMaladies"></div>
  <button class="action" onclick="ajouterMaladie()">+ Ajouter</button>
  <hr>

  <h3>Accidents</h3>
  <div id="listeAccidents"></div>
  <button class="action" onclick="ajouterAccident()">+ Ajouter</button>
  <hr>

  <h3>Traitements</h3>
  <div id="listeTraitements"></div>
  <button class="action" onclick="ajouterTraitement()">+ Ajouter</button>
</section>

<!-- ================= PDF ================= -->
<section id="pdf">
  <h3>Passeport PDF</h3>

  <div class="petit">
    Sur iPhone/iPad, une page web ne peut pas conserver l‚Äôacc√®s direct √† un PDF de l‚Äôapp <b>Fichiers</b> apr√®s fermeture.
    Donc : on peut <b>l‚Äôouvrir maintenant</b>, et pour le rouvrir plus tard il faudra <b>le re-s√©lectionner</b> depuis Fichiers.
  </div>

  <hr>

  <label>S√©lectionner un PDF (Fichiers)</label>
  <input type="file" id="pdfInput" accept="application/pdf">
  <button class="action" onclick="ajouterPDF()">+ Ajouter (m√©mo) & Ouvrir</button>

  <!-- input cach√© utilis√© pour "Ouvrir" un PDF plus tard -->
  <input type="file" id="pdfOpenInput" accept="application/pdf" hidden onchange="ouvrirPDFSelectionne(event)">

  <ul id="listePDF"></ul>
</section>

<!-- ================= LIENS ================= -->
<section id="liens">
  <h3>Liens Web</h3>
  <input id="nomLien" placeholder="Nom">
  <input id="urlLien" placeholder="URL (https://...)">
  <button class="action" onclick="ajouterLien()">+ Ajouter le lien</button>
  <hr>
  <div id="listeLiens"></div>
</section>

</main>

<script>
/* ================= Donn√©es ================= */
const donn√©es = {
  fiche:{},
  maladies:[],
  accidents:[],
  traitements:[],
  pdfs:[],   // { nom, addedISO }
  liens:[]
};

/* ================= Navigation ================= */
function showTab(id, btn){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(btn) btn.classList.add("active");
}

/* ================= Utilitaires ================= */
function nowISO(){ return new Date().toISOString(); }

function safeParse(json, fallback){
  try { return JSON.parse(json); } catch { return fallback; }
}

/* ================= √Çge ================= */
function updateAge(){
  const naissanceEl = document.getElementById("naissance");
  const ageEl = document.getElementById("age");
  if(!naissanceEl.value){ ageEl.textContent = "-"; return; }

  const b = new Date(naissanceEl.value);
  const n = new Date();
  let a = n.getFullYear() - b.getFullYear();
  if(n.getMonth() < b.getMonth() || (n.getMonth() === b.getMonth() && n.getDate() < b.getDate())) a--;
  ageEl.textContent = a + " an" + (a>1 ? "s" : "");
}

/* ================= Sauvegarde ================= */
/* showAlert=false => autosauvegarde silencieuse (√©vite "Donn√©es sauvegard√©es" quand tu cliques sur Ajouter) */
function saveData(showAlert=true){
  // fiche
  donn√©es.fiche = {
    puce:document.getElementById("puce").value,
    passeport:document.getElementById("passeport").value,
    naissance:document.getElementById("naissance").value,
    poids:document.getElementById("poids").value,
    veto:document.getElementById("veto").value,
    tel:document.getElementById("tel").value,
    clinique:document.getElementById("clinique").value,
    nourriture:document.getElementById("nourriture").value,
    accessoires:document.getElementById("accessoires").value,
    autres:document.getElementById("autres").value
  };

  localStorage.setItem("chienData", JSON.stringify(donn√©es));

  if(showAlert) alert("‚úî Donn√©es sauvegard√©es");
}

function exportData(){
  const blob = new Blob([JSON.stringify(donn√©es,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chien_sauvegarde.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function importData(e){
  const f = e.target.files[0];
  if(!f) return;

  const r = new FileReader();
  r.onload = ()=>{
    const obj = safeParse(r.result, null);
    if(!obj || typeof obj !== "object"){ alert("‚ùå Fichier invalide"); return; }

    // Fusion contr√¥l√©e
    donn√©es.fiche = obj.fiche || {};
    donn√©es.maladies = Array.isArray(obj.maladies) ? obj.maladies : [];
    donn√©es.accidents = Array.isArray(obj.accidents) ? obj.accidents : [];
    donn√©es.traitements = Array.isArray(obj.traitements) ? obj.traitements : [];
    donn√©es.pdfs = Array.isArray(obj.pdfs) ? obj.pdfs : [];
    donn√©es.liens = Array.isArray(obj.liens) ? obj.liens : [];

    localStorage.setItem("chienData", JSON.stringify(donn√©es));
    alert("‚úî Importation r√©ussie");
    location.reload();
  };
  r.readAsText(f);
}

/* ================= Liens Web ================= */
function ajouterLien(){
  const nom = document.getElementById("nomLien").value.trim();
  const url = document.getElementById("urlLien").value.trim();
  if(!url) return;

  donn√©es.liens.push({nom: nom || url, url});
  document.getElementById("nomLien").value = "";
  document.getElementById("urlLien").value = "";

  afficherLiens();
  saveData(false);
}

function supprimerLien(i){
  donn√©es.liens.splice(i,1);
  afficherLiens();
  saveData(false);
}

function afficherLiens(){
  const cont = document.getElementById("listeLiens");
  cont.innerHTML = "";
  donn√©es.liens.forEach((l,i)=>{
    cont.innerHTML += `
      <div class="ligne">
        <strong>${escapeHtml(l.nom)}</strong><br>
        <a href="${escapeAttr(l.url)}" target="_blank" rel="noopener">${escapeHtml(l.url)}</a><br>
        <button class="suppr" onclick="supprimerLien(${i})">Supprimer</button>
        <hr>
      </div>
    `;
  });
}

/* ================= PDF (correction iOS) ================= */
/*
  IMPORTANT :
  - Ne plus stocker de URL.createObjectURL(blob) dans les donn√©es (√ßa meurt √† la fermeture).
  - On m√©morise seulement le NOM (et une date d‚Äôajout).
  - Pour ouvrir plus tard : on redemande le fichier via Fichiers (s√©lecteur).
*/
function ajouterPDF(){
  const input = document.getElementById("pdfInput");
  const f = input.files[0];
  if(!f) return;

  // m√©morise seulement le nom
  donn√©es.pdfs.push({ nom: f.name, addedISO: nowISO() });
  afficherPDFs();
  saveData(false);

  // ouvre imm√©diatement (temporaire), puis r√©voque
  ouvrirFichierPDFTemporaire(f);

  // reset input
  input.value = "";
}

function ouvrirFichierPDFTemporaire(file){
  const reader = new FileReader();

  reader.onload = function () {
    const win = window.open();
    if (win) {
      win.location.href = reader.result; // DataURL ‚Üí OK iOS
    } else {
      alert("Autorise l‚Äôouverture des fen√™tres.");
    }
  };

  reader.onerror = function () {
    alert("Erreur lors de la lecture du PDF.");
  };

  reader.readAsDataURL(file);
}

function demanderOuverturePDF(i){
  // on stocke l‚Äôindex demand√© sur l‚Äôinput cach√©
  const openInput = document.getElementById("pdfOpenInput");
  openInput.dataset.index = String(i);
  openInput.click();
}

function ouvrirPDFSelectionne(e){
  const openInput = document.getElementById("pdfOpenInput");
  const idx = parseInt(openInput.dataset.index || "-1", 10);
  const f = e.target.files[0];
  if(!f) return;

  // ouvre, m√™me si le nom ne correspond pas (mais on peut pr√©venir)
  if(idx >= 0 && donn√©es.pdfs[idx] && donn√©es.pdfs[idx].nom && f.name !== donn√©es.pdfs[idx].nom){
    const ok = confirm("Le fichier s√©lectionn√© ne correspond pas au nom m√©moris√©.\n\nM√©moris√© : " + donn√©es.pdfs[idx].nom + "\nS√©lectionn√© : " + f.name + "\n\nOuvrir quand m√™me ?");
    if(!ok){ e.target.value=""; return; }
  }

  ouvrirFichierPDFTemporaire(f);

  // reset
  e.target.value = "";
}

function supprimerPDF(i){
  donn√©es.pdfs.splice(i,1);
  afficherPDFs();
  saveData(false);
}

function afficherPDFs(){
  const ul = document.getElementById("listePDF");
  ul.innerHTML = "";

  if(!donn√©es.pdfs.length){
    ul.innerHTML = `<li class="petit">Aucun PDF m√©moris√©.</li>`;
    return;
  }

  donn√©es.pdfs.forEach((p,i)=>{
    const date = p.addedISO ? formatFR(p.addedISO) : "";
    ul.innerHTML += `
      <li style="margin-bottom:12px;">
        <strong>üìÑ ${escapeHtml(p.nom || "PDF")}</strong><br>
        <span class="petit">Ajout√© : ${escapeHtml(date)}</span><br>
        <button class="action" style="margin-top:6px;" onclick="demanderOuverturePDF(${i})">Ouvrir (re-s√©lectionner dans Fichiers)</button><br>
        <button class="suppr" onclick="supprimerPDF(${i})">Supprimer</button>
      </li>
    `;
  });
}

/* ================= Sant√© (FIX persistance) ================= */
/* Ici, chaque champ met √† jour donn√©es[...] en direct, puis autosave silencieux */
function ajouterMaladie(){
  donn√©es.maladies.push({nom:"", date:"", remarque:""});
  afficherMaladies();
  saveData(false);
}
function supprimerMaladie(i){
  donn√©es.maladies.splice(i,1);
  afficherMaladies();
  saveData(false);
}
function afficherMaladies(){
  const cont = document.getElementById("listeMaladies");
  cont.innerHTML = "";
  donn√©es.maladies.forEach((m,i)=>{
    cont.innerHTML += `
      <input placeholder="Maladie" value="${escapeAttr(m.nom||"")}"
        oninput="donn√©es.maladies[${i}].nom=this.value; saveData(false)">
      <input type="date" value="${escapeAttr(m.date||"")}"
        onchange="donn√©es.maladies[${i}].date=this.value; saveData(false)">
      <textarea oninput="donn√©es.maladies[${i}].remarque=this.value; saveData(false)">${escapeHtml(m.remarque||"")}</textarea>
      <button class="suppr" onclick="supprimerMaladie(${i})">Supprimer</button>
      <hr>
    `;
  });
}

function ajouterAccident(){
  donn√©es.accidents.push({type:"", date:"", suite:""});
  afficherAccidents();
  saveData(false);
}
function supprimerAccident(i){
  donn√©es.accidents.splice(i,1);
  afficherAccidents();
  saveData(false);
}
function afficherAccidents(){
  const cont = document.getElementById("listeAccidents");
  cont.innerHTML = "";
  donn√©es.accidents.forEach((a,i)=>{
    cont.innerHTML += `
      <input placeholder="Accident" value="${escapeAttr(a.type||"")}"
        oninput="donn√©es.accidents[${i}].type=this.value; saveData(false)">
      <input type="date" value="${escapeAttr(a.date||"")}"
        onchange="donn√©es.accidents[${i}].date=this.value; saveData(false)">
      <textarea oninput="donn√©es.accidents[${i}].suite=this.value; saveData(false)">${escapeHtml(a.suite||"")}</textarea>
      <button class="suppr" onclick="supprimerAccident(${i})">Supprimer</button>
      <hr>
    `;
  });
}

function ajouterTraitement(){
  donn√©es.traitements.push({nom:"", debut:"", fin:"", posologie:""});
  afficherTraitements();
  saveData(false);
}
function supprimerTraitement(i){
  donn√©es.traitements.splice(i,1);
  afficherTraitements();
  saveData(false);
}
function afficherTraitements(){
  const cont = document.getElementById("listeTraitements");
  cont.innerHTML = "";
  donn√©es.traitements.forEach((t,i)=>{
    cont.innerHTML += `
      <input placeholder="Traitement" value="${escapeAttr(t.nom||"")}"
        oninput="donn√©es.traitements[${i}].nom=this.value; saveData(false)">
      <label class="petit">D√©but</label>
      <input type="date" value="${escapeAttr(t.debut||"")}"
        onchange="donn√©es.traitements[${i}].debut=this.value; saveData(false)">
      <label class="petit">Fin</label>
      <input type="date" value="${escapeAttr(t.fin||"")}"
        onchange="donn√©es.traitements[${i}].fin=this.value; saveData(false)">
      <textarea placeholder="Posologie / remarque"
        oninput="donn√©es.traitements[${i}].posologie=this.value; saveData(false)">${escapeHtml(t.posologie||"")}</textarea>
      <button class="suppr" onclick="supprimerTraitement(${i})">Supprimer</button>
      <hr>
    `;
  });
}

/* ================= Restauration au chargement ================= */
window.onload = ()=>{
  const s = safeParse(localStorage.getItem("chienData") || "{}", {});
  if(s && typeof s === "object"){
    donn√©es.fiche = s.fiche || {};
    donn√©es.maladies = Array.isArray(s.maladies) ? s.maladies : [];
    donn√©es.accidents = Array.isArray(s.accidents) ? s.accidents : [];
    donn√©es.traitements = Array.isArray(s.traitements) ? s.traitements : [];
    donn√©es.pdfs = Array.isArray(s.pdfs) ? s.pdfs : [];
    donn√©es.liens = Array.isArray(s.liens) ? s.liens : [];
  }

  // Remplir la fiche
  const f = donn√©es.fiche || {};
  setVal("puce", f.puce);
  setVal("passeport", f.passeport);
  setVal("naissance", f.naissance);
  setVal("poids", f.poids);
  setVal("veto", f.veto);
  setVal("tel", f.tel);
  setVal("clinique", f.clinique);
  setVal("nourriture", f.nourriture);
  setVal("accessoires", f.accessoires);
  setVal("autres", f.autres);

  updateAge();

  // Affichages
  afficherLiens();
  afficherPDFs();
  afficherMaladies();
  afficherAccidents();
  afficherTraitements();

  // Autosave quand on tape dans la fiche (optionnel mais pratique)
  ["puce","passeport","poids","veto","tel","clinique","nourriture","accessoires","autres"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.addEventListener("input", ()=>saveData(false));
    }
  });
};

function setVal(id, v){
  const el = document.getElementById(id);
  if(el) el.value = v || "";
}

/* ================= S√©curit√© affichage HTML ================= */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}

/* ================= Format date FR ================= */
function formatFR(iso){
  try{
    const d = new Date(iso);
    if(isNaN(d.getTime())) return "";
    const jj = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const aa = d.getFullYear();
    return `${jj}/${mm}/${aa}`;
  }catch{ return ""; }
}
</script>

</body>
</html>