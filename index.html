<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fiche Chien - Pierre Charlier 2025</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #D0E4F7;
      color: #1C2A40;
      padding: 20px;
    }
    h1 {
      background-color: #2C5E99;
      color: white;
      padding: 12px;
      text-align: center;
      border-radius: 8px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      font-size: 1.1rem;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 5px;
      border: 1px solid #587EA3;
      background-color: #F0F8FF;
      font-size: 1.1rem;
    }
    button {
      background-color: #2C5E99;
      color: white;
      padding: 8px 12px;
      margin: 8px 6px 0 0;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.05rem;
    }
    button:hover {
      background-color: #20446E;
    }
    .photo-preview {
      max-width: 220px;
      margin-top: 12px;
      border: 2px solid #2C5E99;
      border-radius: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background-color: #f9fbff;
      font-size: 1.05rem;
    }
    th, td {
      padding: 10px;
      border: 1px solid #587EA3;
      text-align: left;
    }
    th {
      background-color: #2C5E99;
      color: white;
    }
    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9rem;
      color: #1C2A40;
      border-top: 1px solid #587EA3;
      padding-top: 10px;
    }
    .entry-group {
      border: 1px solid #bbb;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      background-color: #EAF2FB;
    }
    .delete-btn {
      background-color: #c33;
      color: white;
      font-size: 0.95rem;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 4px;
    }
    .delete-btn:hover {
      background-color: #a00;
    }
  </style>
</head>
<body>

<h1>Contr√¥le de mon chien üêæ</h1>

<form id="dogForm">

  <label>N¬∫ Puce</label>
  <input type="text" id="chipId"/>

  <label>N¬∫ Passeport</label>
  <input type="text" id="passportId"/>

  <label>Date de naissance</label>
  <input type="date" id="birthDate"/>

  <label>Poids (kg)</label>
  <input type="number" id="weight" step="0.1"/>

  <!-- VACCINATIONS -->
  <label>Vaccinations (date + produit)</label>
  <div id="vaccinationList"></div>
  <button type="button" onclick="addVaccination()">+ Ajouter vaccination</button>

  <!-- D√âPARASITAGES -->
  <label>D√©parasitage (date + produit)</label>
  <div id="deparasitageList"></div>
  <button type="button" onclick="addDeparasitage()">+ Ajouter d√©parasitage</button>

  <!-- MALADIES -->
  <label>Maladies (date + nom + notes)</label>
  <div id="maladiesList"></div>
  <button type="button" onclick="addMaladie()">+ Ajouter maladie</button>

  <label>Accidents</label>
  <textarea id="accidents"></textarea>

  <label>Laboratoire (Labo)</label>
  <textarea id="labo"></textarea>

  <label>Radiographies (Rx)</label>
  <textarea id="rx"></textarea>

  <label>V√©to / Confr√®res</label>
  <input type="text" id="veto"/>

  <label>T√©l√©phone</label>
  <input type="tel" id="tel"/>

  <label>Clinique / Cabinet</label>
  <input type="text" id="clinic"/>

  <label>Nourriture</label>
  <textarea id="nourriture"></textarea>

  <label>Accessoires</label>
  <textarea id="accessoires"></textarea>

  <label>Autres</label>
  <textarea id="autres"></textarea>

  <label>Photo du chien</label>
  <input type="file" id="photoInput" accept="image/*"/>
  <img id="photoPreview" class="photo-preview" src="" alt=""/>

  <div>
    <button type="button" onclick="exportJSON()">üíæ Exporter JSON</button>
    <button type="button" onclick="document.getElementById('importFile').click()">üìÅ Importer JSON</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)"/>
    <button type="button" onclick="clearData()">üóë Effacer les donn√©es</button>
  </div>

</form>

<table id="dataTable">
  <thead>
    <tr><th>Champ</th><th>Valeur</th></tr>
  </thead>
  <tbody></tbody>
</table>

<footer>¬© Pierre Charlier 2025 ‚Äî Version 1.3</footer>

<script>
const fields = [
  { id: "chipId", label: "N¬∫ Puce" },
  { id: "passportId", label: "N¬∫ Passeport" },
  { id: "birthDate", label: "Date de naissance" },
  { id: "weight", label: "Poids (kg)" },
  { id: "accidents", label: "Accidents" },
  { id: "labo", label: "Laboratoire (Labo)" },
  { id: "rx", label: "Radiographies (Rx)" },
  { id: "veto", label: "V√©to / Confr√®res" },
  { id: "tel", label: "T√©l√©phone" },
  { id: "clinic", label: "Clinique / Cabinet" },
  { id: "nourriture", label: "Nourriture" },
  { id: "accessoires", label: "Accessoires" },
  { id: "autres", label: "Autres" }
];

let photoData = "";
let vaccinations = [];
let deparasitage = [];
let maladies = [];

// Load saved data
window.onload = () => {
  const saved = localStorage.getItem("dogData");
  if (saved) {
    const data = JSON.parse(saved);
    fields.forEach(f => {
      if (data[f.id]) document.getElementById(f.id).value = data[f.id];
    });
    photoData = data.photo || "";
    if (photoData) document.getElementById("photoPreview").src = photoData;
    vaccinations = data.vaccinations || [];
    deparasitage = data.deparasitage || [];
    maladies = data.maladies || [];
    renderEntries();
    updateTable();
  }
};

// Auto-save basic fields
fields.forEach(f => {
  document.getElementById(f.id).addEventListener("input", autoSave);
});

// Photo handling
document.getElementById('photoInput').addEventListener('change', function () {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      photoData = e.target.result;
      document.getElementById('photoPreview').src = photoData;
      autoSave();
    };
    reader.readAsDataURL(file);
  }
});

// Functions for dynamic entries
function addVaccination() {
  vaccinations.push({ date: "", produit: "" });
  renderEntries();
  autoSave();
}

function addDeparasitage() {
  deparasitage.push({ date: "", produit: "" });
  renderEntries();
  autoSave();
}

function addMaladie() {
  maladies.push({ date: "", nom: "", notes: "" });
  renderEntries();
  autoSave();
}

function deleteVaccination(index) {
  vaccinations.splice(index, 1);
  renderEntries();
  autoSave();
}

function deleteDeparasitage(index) {
  deparasitage.splice(index, 1);
  renderEntries();
  autoSave();
}

function deleteMaladie(index) {
  maladies.splice(index, 1);
  renderEntries();
  autoSave();
}

// Render dynamic lists
function renderEntries() {
  const vDiv = document.getElementById("vaccinationList");
  vDiv.innerHTML = "";
  vaccinations.forEach((v, i) => {
    vDiv.innerHTML += `
      <div class="entry-group">
        <input type="date" value="${v.date}" onchange="vaccinations[${i}].date=this.value; autoSave()"/>
        <input type="text" placeholder="Produit" value="${v.produit}" onchange="vaccinations[${i}].produit=this.value; autoSave()"/>
        <button class="delete-btn" onclick="deleteVaccination(${i})">‚ùå Supprimer</button>
      </div>`;
  });

  const dDiv = document.getElementById("deparasitageList");
  dDiv.innerHTML = "";
  deparasitage.forEach((d, i) => {
    dDiv.innerHTML += `
      <div class="entry-group">
        <input type="date" value="${d.date}" onchange="deparasitage[${i}].date=this.value; autoSave()"/>
        <input type="text" placeholder="Produit" value="${d.produit}" onchange="deparasitage[${i}].produit=this.value; autoSave()"/>
        <button class="delete-btn" onclick="deleteDeparasitage(${i})">‚ùå Supprimer</button>
      </div>`;
  });

  const mDiv = document.getElementById("maladiesList");
  mDiv.innerHTML = "";
  maladies.forEach((m, i) => {
    mDiv.innerHTML += `
      <div class="entry-group">
        <input type="date" value="${m.date}" onchange="maladies[${i}].date=this.value; autoSave()"/>
        <input type="text" placeholder="Nom de la maladie" value="${m.nom}" onchange="maladies[${i}].nom=this.value; autoSave()"/>
        <textarea placeholder="Notes" onchange="maladies[${i}].notes=this.value; autoSave()">${m.notes}</textarea>
        <button class="delete-btn" onclick="deleteMaladie(${i})">‚ùå Supprimer</button>
      </div>`;
  });
}

// Auto-save everything
function autoSave() {
  const data = {};
  fields.forEach(f => data[f.id] = document.getElementById(f.id).value);
  data.photo = photoData;
  data.vaccinations = vaccinations;
  data.deparasitage = deparasitage;
  data.maladies = maladies;
  localStorage.setItem("dogData", JSON.stringify(data));
  updateTable();
}

// Pretty date format
function formatDate(d) {
  if (!d) return "";
  const dt = new Date(d);
  return ('0'+dt.getDate()).slice(-2) + "/" + ('0'+(dt.getMonth()+1)).slice(-2) + "/" + dt.getFullYear();
}

// Update summary table
function updateTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  function addRow(label, value) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${label}</td><td>${value}</td>`;
    tbody.appendChild(tr);
  }

  fields.forEach(f => {
  const val = document.getElementById(f.id).value;
  const isDateField = f.id === "birthDate";
  addRow(f.label, isDateField ? formatDate(val) : val);
});

  vaccinations.forEach((v,i) => {
    addRow(`Vaccination ${i+1}`, `${formatDate(v.date)} ‚Äî ${v.produit}`);
  });
  deparasitage.forEach((d,i) => {
    addRow(`D√©parasitage ${i+1}`, `${formatDate(d.date)} ‚Äî ${d.produit}`);
  });
  maladies.forEach((m,i) => {
    addRow(`Maladie ${i+1}`, `${formatDate(m.date)} ‚Äî ${m.nom} (${m.notes})`);
  });

  if (photoData) addRow("Photo", `<img src="${photoData}" style="max-width:100px">`);
}

// Clear all data
function clearData() {
  if (confirm("Supprimer toutes les donn√©es ?")) {
    localStorage.removeItem("dogData");
    location.reload();
  }
}

// JSON export
function exportJSON() {
  const data = {};
  fields.forEach(f => data[f.id] = document.getElementById(f.id).value);
  data.photo = photoData;
  data.vaccinations = vaccinations;
  data.deparasitage = deparasitage;
  data.maladies = maladies;
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "chien_sauvegarde.json";
  link.click();
  URL.revokeObjectURL(url);
}

// JSON import
function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const data = JSON.parse(e.target.result);
      fields.forEach(f => {
        if (data[f.id] !== undefined) document.getElementById(f.id).value = data[f.id];
      });
      photoData = data.photo || "";
      if (photoData) document.getElementById("photoPreview").src = photoData;
      vaccinations = data.vaccinations || [];
      deparasitage = data.deparasitage || [];
      maladies = data.maladies || [];
      renderEntries();
      autoSave();
    } catch {
      alert("Erreur lors de l'import JSON.");
    }
  };
  reader.readAsText(file);
}
</script>

</body>
</html>